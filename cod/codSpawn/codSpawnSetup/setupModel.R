# find some decent starting values for recl and stddev

mla <- mfdb_sample_meanlength_stddev(mdb, c('age'),
                                     c(list(sampling_type=c("SprSurveyTotals",
                                                            "AutSurveyTotals"),
                                            age=0:19),
                                       defaults))
init.sigma <- 
    mla[[1]] %>% 
    na.omit() %>% 
    group_by(age) %>%
    summarize(ml=mean(mean), ms=mean(stddev, na.rm=T))

atl.init.sigma <- 
    rbind(init.sigma, init.sigma) %>%
    arrange(age)

## populate the model with starting default values

## alpha and beta for lw relationship
weight.alpha <- 0.0000021
weight.beta <- 3.3437

# age.mean.formula <- 'exp(-1*(%2$s.M+%3$s.init.F)*%1$s)*%2$s.init.%1$s'
rec.number <- sprintf('%1$s.rec.scalar*%1$s.rec.%2$s', species.name, year.range)
rec.sd <- sprintf('#%s.rec.sd', species.name)

cod0 <- 
    gadgetstock('cod0', gd$dir, missingOkay=T) %>%
    gadget_update('stock',
                  minage = 0,
                  maxage = 1,
                  minlength = 1,
                  maxlength = 60,
                  dl = 5,
                  livesonareas = 1) %>%
    gadget_update('doesgrow',
                  growthparameters=c(linf=sprintf('#%s.linf', species.name), 
                                     k=sprintf('#%s.k', species.name),
                                     alpha=weight.alpha,
                                     beta=weight.beta),
                  beta=sprintf('(* 10 #%s.bbin)', species.name)) %>%
    # gadget_update('naturalmortality', # estimate m for each age
    #               sprintf('#%1$s.age%2$s.m', 
    #                       species.name, 
    #                       .[[1]]$minage:.[[1]]$maxage)) %>%
    gadget_update('naturalmortality', # m as a function of age
                  m.estimate.formula(age=.[[1]]$minage:.[[1]]$maxage,
                                     m=sprintf('%s.m.decay', species.name),
                                     max.m=sprintf('%s.max.m', species.name),
                                     min.m=sprintf('%s.min.m', species.name))) %>%
    gadget_update('initialconditions',
                  normalparam=
                      data_frame(age = .[[1]]$minage:.[[1]]$maxage, 
                                 area = 1,
                                 # age.factor = sprintf('(* 10 #%1$s.init%2$s)',
                                 #                      species.name,
                                 #                      age),
                                 age.factor=init.age.factor(age=age,
                                                            m=sprintf('%s.init.decay', 
                                                                      species.name),
                                                            age.scalar=sprintf('%s.init.scalar', 
                                                                               species.name),
                                                            init.min=sprintf('%s.init.min', 
                                                                             species.name)),
                                 area.factor=sprintf('( * #%1$s.mult #%1$s.init.abund)',
                                                     species.name),
                                 mean = vonb_formula(.[[1]]$minage:.[[1]]$maxage,
                                                     linf=sprintf('%s.linf', species.name),
                                                     k=sprintf('%s.k', species.name),
                                                     recl=sprintf('%s.recl', species.name)),
                                 stddev = init.sigma$ms[1:2],
                                 alpha = weight.alpha,
                                 beta = weight.beta)) %>%
    gadget_update('refweight',
                  data=data_frame(length=seq(.[[1]]$minlength,
                                             .[[1]]$maxlength,
                                             .[[1]]$dl),
                                  mean = weight.alpha*length^weight.beta)) %>%
    gadget_update('iseaten', 1) %>%
    # gadget_update('doesmature', 
    #               maturityfunction = 'continuous',
    #               maturestocksandratios = sprintf('%smat 1',species_name),
    #               coefficients = sprintf('( * 0.001 #%1$s.mat1) #%1$s.mat2 0 0',
    #                                         species_name)) %>% 
    gadget_update('doesmove',
                  transitionstocksandratios = sprintf('%s 1', species.name),
                  transitionstep = 4)



cod <- 
    gadgetstock('cod', gd$dir, missingOkay=T) %>%
    gadget_update('stock',
                  minage = 2,
                  maxage = 19,
                  minlength = 1,
                  maxlength = 199,
                  dl = 5,
                  livesonareas = 1) %>%
    gadget_update('doesgrow',
                  growthparameters=c(linf=sprintf('#%s.linf', species.name), 
                                     k=sprintf('#%s.k', species.name),
                                     alpha=weight.alpha,
                                     beta=weight.beta),
                  beta=sprintf('(* 10 #%s.bbin)', .[[1]]$stockname)) %>%
    # gadget_update('naturalmortality', # m for each age
    #               sprintf('#%1$s.age%2$s.m', 
    #                       .[[1]]$stockname, 
    #                       .[[1]]$minage:.[[1]]$maxage)) %>%
    gadget_update('naturalmortality', # m as a function of age
                  m.estimate.formula(age=.[[1]]$minage:.[[1]]$maxage,
                                     m=sprintf('%s.m.decay', .[[1]]$stockname),
                                     max.m=sprintf('%s.max.m', .[[1]]$stockname),
                                     min.m=sprintf('%s.min.m', .[[1]]$stockname))) %>%
    gadget_update('initialconditions',
                  normalparam=
                      data_frame(age = .[[1]]$minage:.[[1]]$maxage, 
                                 area = 1,
                                 # age.factor = sprintf('(* 10 #%1$s.init%2$s)',
                                 #                      .[[1]]$stockname,
                                 #                      age),
                                 age.factor=init.age.factor(age=age,
                                                            m=sprintf('%s.init.decay', 
                                                                      .[[1]]$stockname),
                                                            age.scalar=sprintf('%s.init.scalar', 
                                                                               .[[1]]$stockname),
                                                            init.min=sprintf('%s.init.min', 
                                                                             .[[1]]$stockname)),
                                 area.factor=sprintf('( * #%1$s.mult #%1$s.init.abund)',
                                                     .[[1]]$stockname),
                                 mean = vonb_formula(.[[1]]$minage:.[[1]]$maxage,
                                                     linf=sprintf('%s.linf', species.name),
                                                     k=sprintf('%s.k', species.name),
                                                     recl=sprintf('%s.recl', species.name)),
                                 stddev = init.sigma$ms[((.[[1]]$minage)+1):
                                                         ((.[[1]]$maxage)+1)],
                                 alpha = weight.alpha,
                                 beta = weight.beta)) %>%
    gadget_update('refweight',
                  data=data_frame(length=seq(.[[1]]$minlength,
                                             .[[1]]$maxlength,
                                             .[[1]]$dl),
                                  mean = weight.alpha*length^weight.beta)) %>%
    gadget_update('iseaten', 1) %>%
    gadget_update("doesspawn",
                  spawnfile = eval(spawnfile(., st.year, end.year)))



write.gadget.file(cod0, gd$dir)
write.gadget.file(cod, gd$dir)


# ## create and write out spawnfile
# spawnfile <- list(
#     spawnsteps='spawnsteps 1',
#     spawnareas='spawnareas 1',
#     firstspawnyear= sprintf('firstspawnyear %s', st.year),
#     lastspawnyear=sprintf('lastspawnyear %s', end.year),
#     spawnstocksandratios=sprintf('spawnstocksandratios\t%s\t1',
#                                  species.name),
#     proportionfunction="proportionfunction\tconstant\t1",
#     mortalityfunction="mortalityfunction\tconstant\t0",
#     weightlossfunction="weightlossfunction\tconstant\t0",
#     recruitment = 
#         sprintf('recruitment\tbevertonholt\t#%1$s.bh.mu\t#%1$s.bh.lam',
#                 species.name),
#     stockparameters = paste('stockparameters',
#                             vonb_formula(age=0,
#                                          linf=sprintf('%s.linf', species.name),
#                                          k=sprintf('%s.k', species.name),
#                                          recl=sprintf('%s.recl', species.name)),
#                             sprintf('#%s.rec.sd', species.name),
#                             weight.alpha,
#                             weight.beta,
#                             sep='\t')
#     
# )
# 
# cat(sapply(spawnfile, toString),
#     file=paste(getwd(), gd$dir, 
#                sprintf('Modelfiles/%s.spawnfile', species.name),
#                sep='/'),
#     sep='\n')
